<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>my-view1</title>

  <!-- MAIN IMPORTS -->
  <!-- <script src="/node_modules/@webcomponents/webcomponentsjs/custom-elements-es5-adapter.js"></script> -->
  <script src="/node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <!-- <script src="/node_modules/@webcomponents/webcomponentsjs/webcomponents-lite.js"></script> -->
  <script src="/node_modules/web-component-tester/browser.js"></script>
  <script src="/node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <!-- <script src="/node_modules/@polymer/iron-test-helpers/mock-interactions.js"></script> -->

  <!-- Import the element to test -->
  <script type="module" src="../src/bingo-app.js"></script>
  <!-- <script type="module" src="../../@polymer/polymer/lib/utils/render-status.js"></script> -->
</head>

<body>

  <!-- https://github.com/PolymerElements/test-fixture/issues/47 -->
  <test-fixture id="BasicView">
    <template>
      <bingo-app></bingo-app>
    </template>
  </test-fixture>

  <script type="module">
    // import '/node_modules/@polymer/iron-test-helpers/mock-interactions.js'

    import { afterNextRender } from '../../@polymer/polymer/lib/utils/render-status.js';
    window.afterNextRender = afterNextRender

    // import '../src/bingo-app.js';
    // import * as gestures from '../../polymer/lib/utils/gestures.js';
    // import { resetMouseCanceller } from '../../polymer/lib/utils/gestures.js';



    suite('<bingo-app>', () => {
      let bingoApp;
      let routeDeBase
      let menu

      setup(() => {
        bingoApp = fixture('BasicView');
        routeDeBase = bingoApp.route.path
        menu = bingoApp.shadowRoot.querySelector('bingo-menu')
      });

      suite('Tester les routes', () => {

        test('Le menu devrait être présent', function (done) {
          afterNextRenderAll(menu, () => {
            // Polymer.Base.async(function () {
              try {
                assert.equal(menu.tagName, 'BINGO-MENU');
                // expect(button.elevation).to.be.eql(1);
                done();
              } catch (e) {
                done(e);
              }
            // }, 1);
          })
        });
        // history.state === couleurs

        test(`Couleurs devrait s'afficher si on clique sur le premier bouton`, function (done) {
          clickMenu(menu, () => {
            const couleurs = bingoApp.shadowRoot.querySelector('bingo-couleurs')
            const cases = couleurs.shadowRoot.querySelectorAll('bingo-case')
            assert.equal(cases.length, 25);
            done()
          })
        });

        test.skip(`En cliquant sur le bouton maison, on devrait retourner au menu`, function (done) {
          clickMenu(menu, () => {
            const couleurs = bingoApp.shadowRoot.querySelector('bingo-couleurs')
            const button = menu.shadowRoot.querySelector('.bouton-menu')

            afterNextRenderAll(button, () => {

            // Base.async(function () {
              try {
                window.addEventListener('location-changed', function (e) {
                  console.log('location-changed')
                  window.setTimeout(() => {
                    const couleurs = bingoApp.shadowRoot.querySelector('bingo-couleurs')
                    const cases = couleurs.shadowRoot.querySelectorAll('bingo-case')
                    assert.equal(cases.length, 25);
                    done()
                  }, 1000)
                })

                button.addEventListener('click', function () {
                  console.log('click');
                });

                button.click()
                // MockInteractions.tap(button);

              } catch (e) {
                done(e);
              }
            // }, 1);
            })
          })
        });
      })
    });

    /**
     * @params {String[]} elements
     * @params {Function} callback
     */
    function afterNextRenderAll(elements, callback) {
      elements = [elements]
      var renderedCount = 0;

      function elementRendered() {
        renderedCount++;
        if (renderedCount === elements.length) {
          callback();
        }
      }
      elements.forEach(function (element) {
        afterNextRender(element, elementRendered);
      });
    }

    function clickMenu(menu, callBack) {
      const button = menu.shadowRoot.querySelector('.bouton-menu')

      afterNextRenderAll(button, () => {
      // Base.async(function () {
        try {
          window.addEventListener('location-changed', function (e) {
            console.log('location-changed')
            window.setTimeout(() => {
              afterNextRender('bingo-couleurs', () => {
                callBack()
              })
            }, 1000)
          })
          button.addEventListener('click', function () {
            console.log('click');
          });
          button.click()
          // MockInteractions.tap(button);

        } catch (e) {
          done(e);
        }
        // }, 1);
      })
    }

  </script>
</body>
</html>
